//
// cubeRDP/src/main.c: RDP test cart (entry point).
//
// n64chain: A (free) open-source N64 development toolchain.
// Copyright 2014-16 Tyler J. Stachecki <stachecki.tyler@gmail.com>
//
// This file is subject to the terms and conditions defined in
// 'LICENSE', which is part of this source code package.
//

#include <rcp/vi.h>
#include <stdint.h>
#include <syscall.h>
#include "rdp.c"
#include "3d.c"
#include "3dscene.c"

#define IS_TEXTURED 1


// These pre-defined values are suitable for NTSC.
// TODO: Add support for PAL and PAL-M televisions.
static vi_state_t vi_state = {
  0x0000324E, // status
  0x00200000, // origin
  0x00000140, // width
  0x00000002, // intr
  0x00000000, // current
  0x03E52239, // burst
  0x0000020D, // v_sync
  0x00000C15, // h_sync
  0x0C150C15, // leap
  0x006C02EC, // h_start
  0x002501FF, // v_start
  0x000E0204, // v_burst
  0x00000200, // x_scale
  0x00000400, // y_scale
};


#if IS_TEXTURED
//text from tlut4BPPRDP/src/main.c: 

static uint8_t Texture64x64[2048] = {
  0x33,0x33,0x33,0x33,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00, // 64x64x4B = 2048 Bytes
  0x33,0x33,0x33,0x33,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x21,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x33,0x33,0x33,0x33,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x33,0x33,0x33,0x33,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x21,0x11,0x11,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x33,0x33,0x33,0x33,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x33,0x33,0x33,0x33,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x21,0x11,0x11,0x11,0x11,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x33,0x33,0x33,0x33,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x33,0x33,0x33,0x33,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x21,0x11,0x11,0x11,0x11,0x11,0x11,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x21,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x21,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x21,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x21,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x21,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x21,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x12,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x21,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x12,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x21,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x12,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,
  0x00,0x00,0x00,0x21,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x12,0x00,0x00,0x00,
  0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,
  0x00,0x00,0x21,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x12,0x00,0x00,
  0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,
  0x00,0x21,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x12,0x00,
  0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,
  0x21,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x12,
  0x21,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x12,
  0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x11,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};

static uint16_t Tlut[48] = {
  0x0000,0xFFFF,0x0001,0xF001,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000, // 4B Palette 0 (3x16 = 48 Shorts)
  0x0000,0xF0FF,0x0001,0xF001,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000, // 4B Palette 1
  0x0000,0x0FFF,0x0001,0xF001,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000, // 4B Palette 2
};

#endif


// Draw Fill Triangle (From 3 Unsorted X/Y Points, With Fill Color)
void rdp_draw_txt_triangle( float x1, float y1, float x2, float y2, float x3, float y3 )
{
    float temp_x, temp_y;

    // Sort Vertices By Y Ascending To Find The Major, Mid & Low Edges
    if( y1 > y2 ) { temp_x = x2, temp_y = y2; y2 = y1; y1 = temp_y; x2 = x1; x1 = temp_x; }
    if( y2 > y3 ) { temp_x = x3, temp_y = y3; y3 = y2; y2 = temp_y; x3 = x2; x2 = temp_x; }
    if( y1 > y2 ) { temp_x = x2, temp_y = y2; y2 = y1; y1 = temp_y; x2 = x1; x1 = temp_x; }

    // yh = y1, ym = y2, yl = y3
    // xh = x1, xm = x1, xl = x2
    // Calculate Inverse Slopes
    float dxhdy = ( y3 == y1 ) ? 0 : ( ( x3 - x1 ) / ( y3 - y1 ) );
    float dxmdy = ( y2 == y1 ) ? 0 : ( ( x2 - x1 ) / ( y2 - y1 ) );
    float dxldy = ( y3 == y2 ) ? 0 : ( ( x3 - x2 ) / ( y3 - y2 ) );

    // Determine Triangle Winding Left Major Flag
    int Hdx = x3 - x1; int Hdy = y3 - y1;
    int Mdx = x2 - x1; int Mdy = y2 - y1;
    int r = Hdx * Mdy - Hdy * Mdx;
    int lft = r < 0 ? 1 : 0;

// Command & Edge Coefficients

 #if IS_TEXTURED
    
           
// Texture Triangle (Textured Non-Shaded) Edge Coefficients
//void rdp_texture_triangle( uint8_t lft, uint8_t level, uint8_t tile, float yl, float ym, float yh, float xl, float dxldy, float xh, float dxhdy, float xm, float dxmdy )


	rdp_texture_triangle( lft, 0, 0, y3, y2, y1, x2, dxldy, x1, dxhdy, x1, dxmdy ); // lft, Level, Tile, YL, YM, YH, XL,DxLDy, XH,DxHDy, XM, DxMDy
	// rdp_texture_rectangle(x1,dxhdy, x2,dxmdy, 0.0,0.0, 1.0,1.0, 0); // Texture Rectangle: XH,YH, XL,YL, S,T, DSDX,DTDY, Tile

	
   #else
     
// Fill Triangle (Flat Non-Shaded) Edge Coefficients
//void rdp_fill_triangle( uint8_t lft, uint8_t level, uint8_t tile, float yl, float ym, float yh, float xl, float dxldy, float xh, float dxhdy, float xm, float dxmdy )

        rdp_fill_triangle( lft, 0, 0, y3, y2, y1, x2, dxldy, x1, dxhdy, x1, dxmdy ); // lft, Level, Tile, YL, YM, YH, XL,DxLDy, XH,DxHDy, XM, DxMDy
  #endif
}
 

// fill_text_triangle_array: Vert Array, Color Array, Culling, Base, Length
void fill_text_triangle_array( float vert[], uint8_t col[], uint8_t cull, uint32_t base, uint32_t length)
{
  for(uint32_t v = base, c = (base / 9) << 2; v < (base + length); v += 9, c += 4) {
    // Calculate 3D Points
    XYZResult xyz1 = calc_3d(Matrix3D, vert[v], vert[v + 1], vert[v + 2]);
    XYZResult xyz2 = calc_3d(Matrix3D, vert[v + 3], vert[v + 4], vert[v + 5]);
    XYZResult xyz3 = calc_3d(Matrix3D, vert[v + 6], vert[v + 7], vert[v + 8]);

    // Calculate 2D Points
    XYResult xy1 = calc_2d(xyz1.x, xyz1.y, xyz1.z);
    XYResult xy2 = calc_2d(xyz2.x, xyz2.y, xyz2.z);
    XYResult xy3 = calc_2d(xyz3.x, xyz3.y, xyz3.z);

    // Test Polygon Winding Direction (IF Triangle Winding > 0.0: Clockwise ELSE: Anti-Clockwise)
    int winding = poly_winding(xy1.x,xy1.y, xy2.x,xy2.y, xy3.x,xy3.y);

    if((cull == CULL_NONE) || ((winding <= 0) && (cull == CULL_BACK)) || ((winding > 0) && (cull == CULL_FRONT))) {
      rdp_set_blend_color(col[c], col[c + 1], col[c + 2], col[c + 3]); // Set Blend Color: R,G,B,A
    
      rdp_draw_txt_triangle( xy1.x,xy1.y, xy2.x,xy2.y, xy3.x,xy3.y ); // Draw Fill Triangle: X1,Y1, X2,Y2, X3,Y3
   


      rdp_sync_pipe(); // Stall Pipeline, Until Preceeding Primitives Completely Finish
    }
  }
}



void main(void *unused __attribute__((unused))) {
  // Register VI interrupts on this thread. When registering a thread w/
  // interrupts, it causes the threads message queue to get populated w/
  // a message each time an interrupt fires.
  libn64_thread_reg_intr(libn64_thread_self(), LIBN64_INTERRUPT_VI);

  // Variables
  uint16_t XRot = 0; // X Rotation Value (0..1023)
  uint16_t YRot = 0; // Y Rotation Value (0..1023)
  uint16_t ZRot = 0; // Z Rotation Value (0..1023)

  // Setup RDP buffer
  uint32_t rdp_start = memory_pos;
  rdp_set_scissor(0.0,0.0, 320.0,240.0, SCISSOR_FIELD_DISABLE,SCISSOR_EVEN); // Set Scissor: XH,YH, XL,YL, Scissor Field Enable,Field
  rdp_set_other_modes(CYCLE_TYPE_FILL); // Set_Other_Modes: CYCLE_TYPE_FILL


// Setup RDP frame buffer
  uint32_t rdp_fb_origin = memory_pos + 4;
  
  
#if IS_TEXTURED
 // Variables
  float x = 48.0;
  float y = 8.0;
  
  rdp_set_color_image(IMAGE_DATA_FORMAT_RGBA,SIZE_OF_PIXEL_16B,320, 0x00000000); // Set Color Image: Format,Size, Width, DRAM Address
  rdp_set_fill_color(255,230,0,255); // Set Fill Color: R,G,B,A (Yellow)
  rdp_fill_rectangle(0.0,0.0, 319.0,239.0); // Fill Rectangle: XH,YH, XL,YL
  rdp_sync_pipe(); // Stall Pipeline, Until Preceeding Primitives Completely Finish

  rdp_set_other_modes(EN_TLUT|SAMPLE_TYPE|BI_LERP_0|ALPHA_DITHER_SEL_NO_DITHER|B_M2A_0_1|FORCE_BLEND|IMAGE_READ_EN); // Set Other Modes
  rdp_set_combine_mode(0x0,0x00, 0,0, 0x6,0x01, 0x0,0xF, 1,0, 0,0,0, 7,7,7); // Set Combine Mode: SubA RGB0,MulRGB0, SubA Alpha0,MulAlpha0, SubA RGB1,MulRGB1, SubB RGB0,SubB RGB1, SubA Alpha1,MulAlpha1, AddRGB0,SubB Alpha0,AddAlpha0, AddRGB1,SubB Alpha1,AddAlpha1

  rdp_set_texture_image(IMAGE_DATA_FORMAT_RGBA,SIZE_OF_PIXEL_16B,1, (uint32_t)Tlut); // Set Texture Image: Format,Size,Width, DRAM Address
  rdp_set_tile(0,0,0, 0x100, 0,0, 0,0,0,0, 0,0,0,0); // Set Tile: TMEM Address, Tile
  rdp_load_tlut(0.0,0.0, 47.0,0.0, 0); // Load Tlut: SL,TL, SH,TH, Tile

  rdp_sync_tile(); // Sync Tile
  rdp_set_texture_image(IMAGE_DATA_FORMAT_RGBA,SIZE_OF_PIXEL_16B,16, (uint32_t)Texture64x64); // Set Texture Image: Format,Size,Width, DRAM Address
  rdp_set_tile(IMAGE_DATA_FORMAT_RGBA,SIZE_OF_PIXEL_16B,4, 0x000, 0,0, 0,0,0,0, 0,0,0,0); // Set Tile: Format,Size,Tile Line Size (64bit Words), TMEM Address, Tile
  rdp_load_tile(0.0,0.0, 63.0,63.0, 0); // Load Tile: SL,TL, SH,TH, Tile
  rdp_sync_tile(); // Sync Tile
  rdp_set_tile(IMAGE_DATA_FORMAT_COLOR_INDX,SIZE_OF_PIXEL_4B,4, 0x000, 0,PALETTE_2, 0,0,0,0, 0,0,0,0); // Set Tile: Format,Size,Tile Line Size (64bit Words), TMEM Address, Tile,Palette
 // uint32_t rdp_rectangle = memory_pos;
 // rdp_texture_rectangle(x,y, x+64.0,y+64.0, 0.0,0.0, 1.0,1.0, 0); // Texture Rectangle: XH,YH, XL,YL, S,T, DSDX,DTDY, Tile
 // rdp_sync_full(); // Ensure Entire Scene Is Fully Drawn
  
#else

  rdp_set_color_image(IMAGE_DATA_FORMAT_RGBA,SIZE_OF_PIXEL_16B, 320, 0x00000000); // Set Color Image: Format,Size, Width, DRAM Address
  rdp_set_fill_color(24,128,212,255); // Set Fill Color: R,G,B,A (Blue)
  rdp_fill_rectangle(0.0,0.0, 319.0,239.0); // Fill Rectangle: XH,YH, XL,YL
  rdp_sync_pipe(); // Stall Pipeline, Until Preceeding Primitives Completely Finish

  rdp_set_other_modes(SAMPLE_TYPE|BI_LERP_0|ALPHA_DITHER_SEL_NO_DITHER|B_M1A_0_2); // Set Other Modes
  rdp_set_combine_mode(0x0,0x00, 0,0, 0x6,0x01, 0x0,0xF, 1,0, 0,0,0, 7,7,7); // Set Combine Mode: SubA RGB0,MulRGB0, SubA Alpha0,MulAlpha0, SubA RGB1,MulRGB1, SubB RGB0,SubB RGB1, SubA Alpha1,MulAlpha1, AddRGB0,SubB Alpha0,AddAlpha0, AddRGB1,SubB Alpha1,AddAlpha1
#endif


  uint32_t rdp_buffer = memory_pos; // Set RDP Buffer Address

  // For each frame...
  while (1) {
    // Point to VI to the last fb, swap the front and back fbs.
    vi_flush_state(&vi_state);
    vi_state.origin ^= 0x100000; // 1MB

    // RDP set color image to last fb, clear the framebuffer to fill color
    *(uintptr_t *)(0xA0100000 | rdp_fb_origin) = vi_state.origin; // Set Color Image: DRAM ADDRESS vi_state.origin

    // Draw scene
    // translate_x(Matrix3D, 50.0); // Translate: Matrix, X
    // translate_y(Matrix3D, 50.0); // Translate: Matrix, Y
    // translate_z(Matrix3D, 50.0); // Translate: Matrix, Z
    // translate_xyz(Matrix3D, CubeAPos[0], CubeAPos[1], CubeAPos[2]); // Translate: Matrix, X, Y, Z
    // rotate_x(Matrix3D, SinCos1024, XRot); // Rotate: Matrix, Precalc Table, X
    // rotate_y(Matrix3D, SinCos1024, YRot); // Rotate: Matrix, Precalc Table, Y
    // rotate_z(Matrix3D, SinCos1024, ZRot); // Rotate: Matrix, Precalc Table, Z
    // rotate_xy(Matrix3D, SinCos1024, XRot, YRot); // Rotate: Matrix, Precalc Table, X, Y
    // rotate_xz(Matrix3D, SinCos1024, XRot, ZRot); // Rotate: Matrix, Precalc Table, X, Z
    // rotate_yz(Matrix3D, SinCos1024, YRot, ZRot); // Rotate: Matrix, Precalc Table, Y, Z
    // rotate_xyz(Matrix3D, SinCos1024, XRot, YRot, ZRot); // Rotate: Matrix, Precalc Table, X, Y, Z

    memory_pos = rdp_buffer; // Set Start Of RDP Buffer

    matrix_identity(Matrix3D); // Reset Matrix To Identity
    translate_xyz(Matrix3D, CubeRedPos[0], CubeRedPos[1], CubeRedPos[2]); // Translate: Matrix, X, Y, Z
    rotate_x(Matrix3D, Sin1024, XRot); // Rotate: Matrix, Precalc Table, X
    fill_text_triangle_array(CubeTri, CubeRedCol, CULL_BACK, 0, 108); // Fill Triangle Array: Vert Array, Color Array, RDP Buffer, Culling, Base, Length



    matrix_identity(Matrix3D); // Reset Matrix To Identity
    translate_xyz(Matrix3D, CubeGreenPos[0], CubeGreenPos[1], CubeGreenPos[2]); // Translate: Matrix, X, Y, Z
    rotate_y(Matrix3D, Sin1024, YRot); // Rotate: Matrix, Precalc Table, Y
    fill_text_triangle_array(CubeTri, CubeGreenCol, CULL_BACK, 0, 108); // Fill Triangle Array: Vert Array, Color Array, RDP Buffer, Culling, Base, Length

    matrix_identity(Matrix3D); // Reset Matrix To Identity
    translate_xyz(Matrix3D, CubeBluePos[0], CubeBluePos[1], CubeBluePos[2]); // Translate: Matrix, X, Y, Z
    rotate_z(Matrix3D, Sin1024, ZRot); // Rotate: Matrix, Precalc Table, Z
    fill_text_triangle_array(CubeTri, CubeBlueCol, CULL_BACK, 0, 108); // Fill Triangle Array: Vert Array, Color Array, RDP Buffer, Culling, Base, Length

    matrix_identity(Matrix3D); // Reset Matrix To Identity
    translate_xyz(Matrix3D, CubeYellowPos[0], CubeYellowPos[1], CubeYellowPos[2]); // Translate: Matrix, X, Y, Z
    rotate_xy(Matrix3D, Sin1024, XRot, YRot); // Rotate: Matrix, Precalc Table, X, Y
    fill_text_triangle_array(CubeTri, CubeYellowCol, CULL_BACK, 0, 108); // Fill Triangle Array: Vert Array, Color Array, RDP Buffer, Culling, Base, Length

    matrix_identity(Matrix3D); // Reset Matrix To Identity
    translate_xyz(Matrix3D, CubePurplePos[0], CubePurplePos[1], CubePurplePos[2]); // Translate: Matrix, X, Y, Z
    rotate_xz(Matrix3D, Sin1024, XRot, ZRot); // Rotate: Matrix, Precalc Table, X, Z
    fill_text_triangle_array(CubeTri, CubePurpleCol, CULL_BACK, 0, 108); // Fill Triangle Array: Vert Array, Color Array, RDP Buffer, Culling, Base, Length

    matrix_identity(Matrix3D); // Reset Matrix To Identity
    translate_xyz(Matrix3D, CubeCyanPos[0], CubeCyanPos[1], CubeCyanPos[2]); // Translate: Matrix, X, Y, Z
    rotate_xyz(Matrix3D, Sin1024, XRot, YRot, ZRot); // Rotate: Matrix, Precalc Table, X, Y, Z
    fill_text_triangle_array(CubeTri, CubeCyanCol, CULL_BACK, 0, 108); // Fill Triangle Array: Vert Array, Color Array, RDP Buffer, Culling, Base, Length

    rdp_sync_full(); // Ensure Entire Scene Is Fully Drawn

    rdp_run(rdp_start, memory_pos); // Run RDP buffer: Start, End

    // Update triangle rotation variables
    XRot = (XRot + 1) & 1023;
    YRot = (YRot + 1) & 1023;
    ZRot = (ZRot + 1) & 1023;

    // Block until the next VI interrupt comes in.
    libn64_recvt_message();
  }
}
